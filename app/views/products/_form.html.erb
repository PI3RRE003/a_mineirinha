<%= form_with(model: product, class: "contents") do |form| %>
  <% if product.errors.any? %>
    <div id="error_explanation" class="bg-red-50 text-red-500 px-3 py-2 font-medium rounded-md mt-3 border border-red-200">
      <h2><%= pluralize(product.errors.count, "erro") %> impediu(ram) este produto de ser salvo:</h2>
      <ul class="list-disc ml-6">
        <% product.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="my-5">
    <%= form.label :nome, class: "font-medium text-gray-700" %>
    <%= form.text_field :nome, class: ["block shadow-sm rounded-md border px-3 py-2 mt-2 w-full focus:ring-2 focus:ring-offset-1 transition-colors", {"border-gray-300 focus:outline-none focus:border-orange-500 focus:ring-orange-500": product.errors[:nome].none?, "border-red-400 focus:outline-red-600": product.errors[:nome].any?}] %>
  </div>

  <%# --- CAMPO DESCRI√á√ÉO (Corrigido para 100 caracteres) --- %>
  <div class="my-5">
    <%= form.label :descricao, "Descri√ß√£o", class: "font-medium text-gray-700" %>
    <div class="relative mt-2">
      <%= form.text_area :descricao, 
          rows: 4, 
          maxlength: 100, 
          oninput: "document.getElementById('contador').innerText = (100 - this.value.length) + ' caracteres restantes'",
          class: ["block shadow-sm rounded-md border px-3 py-2 w-full focus:ring-2 focus:ring-offset-1 transition-colors resize-none", 
          {"border-gray-300 focus:outline-none focus:border-orange-500 focus:ring-orange-500": product.errors[:descricao].none?, 
           "border-red-400 focus:outline-red-600": product.errors[:descricao].any?}] 
      %>
      <div class="absolute bottom-2 px-3 py-2 right-2 text-xs font-bold text-gray-400 bg-white/90 px-2 rounded pointer-events-none">
        <span id="contador"><%= 100 - (product.descricao&.length || 0) %> caracteres restantes</span>
      </div>
    </div>
    <p class="mt-1 text-xs text-gray-500 px-3 py-8">M√°ximo de 100 caracteres.</p>
  </div>

  <%# --- CAMPO DE IMAGEM COM VALIDA√á√ÉO JS --- %>
  <div class="my-6">
    <%= form.label :imagem, "Foto do Produto", class: "block font-medium text-stone-700 mb-2" %>
    <% if product.imagem.attached? && product.imagem.persisted? %>
      <div class="mb-3 p-2 bg-stone-50 border border-stone-100 rounded-xl inline-block">
        <%= image_tag product.imagem.variant(resize_to_limit: [150, 150]), class: "h-32 w-32 object-cover rounded-lg border border-orange-200 shadow-sm" %>
        <p class="text-xs text-stone-500 mt-1 text-center">Imagem Atual</p>
      </div>
    <% end %>

    <%= form.file_field :imagem, 
        accept: 'image/png,image/jpeg,image/jpg',
        onchange: "validateFiles(this);",
        class: "block w-full text-sm text-stone-500
      file:mr-4 file:py-2.5 file:px-6
      file:rounded-full file:border-0
      file:text-sm file:font-bold
      file:bg-orange-50 file:text-orange-700
      file:cursor-pointer file:transition-colors
      hover:file:bg-orange-100
      cursor-pointer rounded-lg border border-stone-200 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500" %>
    <p class="mt-1 text-xs text-stone-400">Formatos aceitos: JPG, PNG. M√°ximo 5MB.</p>
  </div>

  <div class="my-5">
    <%= form.label :preco, "Pre√ßo (R$)", class: "font-medium text-gray-700" %>
    <%= form.text_field :preco, class: ["block shadow-sm rounded-md border px-3 py-2 mt-2 w-full focus:ring-2 focus:ring-offset-1 transition-colors", {"border-gray-300 focus:outline-none focus:border-orange-500 focus:ring-orange-500": product.errors[:preco].none?, "border-red-400 focus:outline-red-600": product.errors[:preco].any?}] %>
  </div>

  <div class="my-5 flex items-center gap-2">
    <%= form.check_box :disponivel, class: ["block shadow-sm rounded text-orange-600 focus:ring-orange-500 border-gray-300 h-5 w-5 cursor-pointer", {"border-gray-300": product.errors[:disponivel].none?, "border-red-400": product.errors[:disponivel].any?}] %>
    <%= form.label :disponivel, "Produto Dispon√≠vel?", class: "font-medium text-gray-700 cursor-pointer select-none" %>
  </div>

  <%# --- CAMPO FIDELIDADE --- %>
  <div class="mt-4 mb-4 flex items-center gap-3 bg-orange-50 p-4 rounded-xl border border-[#32491E]">
    <%= form.check_box :gera_pontos, class: "w-6 h-6 text-[#32491E] border-stone-300 rounded focus:ring-[#32491E]" %>
    <%= form.label :gera_pontos, "Este produto gera Ponto de Fidelidade? üßÄ", class: "font-bold text-[#32491E] cursor-pointer" %>
  </div>

  <%# --- CAMPO COMBO --- %>
  <div class="mt-4 mb-4 flex items-center gap-3 bg-amber-100 p-4 rounded-xl border border-amber-500">
    <%= form.check_box :is_combo, class: "w-6 h-6 text-orange-600 border-stone-300 rounded focus:ring-orange-500" %>
    <div>
      <%= form.label :is_combo, "Este produto √© um Combo? üì¶", class: "font-bold text-stone-800 cursor-pointer" %>
      <p class="text-[10px] text-stone-600 uppercase font-black tracking-tight">Habilita a escolha de 3 sabores pelo cliente</p>
    </div>
  </div>

  <%# TIPO DE COMBO / M√öLTIPLOS V√çNCULOS %>
  <div class="mt-4 mb-8 bg-stone-50 p-4 rounded-xl border-2 border-dashed border-stone-300">
    <%= form.label :combo_type, "Vincular a quais Combos? (Separe por v√≠rgula)", class: "block font-bold text-stone-700 text-sm uppercase mb-2" %>
    
    <%= form.text_field :combo_type, 
        placeholder: "Ex: Combo 1, Combo 2", 
        class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-[#32491E] focus:ring-[#32491E] text-sm py-2 px-3 bg-white" 
    %>

    <div class="mt-3 flex gap-2 items-start">
      <span class="text-lg">üí°</span>
      <p class="text-[10px] text-stone-500 font-medium leading-relaxed">
        Para que um sabor apare√ßa em v√°rios combos, escreva os nomes separados por v√≠rgula.<br>
        <strong class="text-stone-700 font-bold">Exemplo:</strong> Se voc√™ escrever <code class="bg-stone-200 px-1">Combo 1, Combo 2</code>, este sabor aparecer√° em ambos.
      </p>
    </div>
  </div>
  <div class="inline">
    <%= form.submit "Salvar Produto", class: "w-full sm:w-auto rounded-md px-4 py-2.5 bg-[#32491E] hover:bg-amber-100 text-amber-100 hover:text-[#32491E] font-bold tracking-wide shadow-sm hover:shadow-md cursor-pointer transition-all duration-200" %>
  </div>
<% end %>

<script>
  function validateFiles(inputFile) {
    var maxExceededMessage = "Essa imagem √© muito grande (maior que 5MB). Por favor, escolha uma menor.";
    var maxFileSize = 5 * 1024 * 1024; // 5MB
    if (inputFile.files && inputFile.files[0]) {
      if (inputFile.files[0].size > maxFileSize) {
        alert(maxExceededMessage);
        inputFile.value = null;
      }
    }
  }
</script>